import { Trie } from './trie';
import { getIndexedDBCache } from './indexeddb-cache';

// For MVP, we'll use a subset of common words
// In production, this would load the full ENABLE dictionary (172,820 words)
const SAMPLE_DICTIONARY = `
ABLE ABOUT ABOVE ABUSE ACCEPT ACCESS ACCOUNT ACHIEVE ACID ACROSS ACT ACTION ACTIVE ACTIVITY ACTOR ACTUAL
ADAPT ADD ADDRESS ADJUST ADMIT ADOPT ADULT ADVANCE ADVICE AFFECT AFFORD AFRAID AFTER AGAIN AGAINST AGE
AGENT AGREE AHEAD AID AIM AIR ALARM ALBUM ALERT ALIEN ALIVE ALL ALLOW ALMOST ALONE ALONG ALREADY ALSO
ALTER ALWAYS AMATEUR AMAZING AMONG AMOUNT ANALYSIS ANALYST ANALYZE ANCIENT ANGER ANGLE ANGRY ANIMAL ANKLE
ANNUAL ANOTHER ANSWER ANTENNA ANTIQUE ANXIETY ANY APART APOLOGY APPEAR APPLE APPROVE APRIL ARCH ARCTIC
AREA ARENA ARGUE ARGUMENT ARISE ARM ARMED ARMOR ARMY AROUND ARRANGE ARREST ARRIVE ARROW ART ARTICLE
ARTIST ARTWORK ASK ASPECT ASSAULT ASSET ASSIST ASSUME ASTHMA ATHLETE ATOM ATTACK ATTEMPT ATTEND ATTITUDE
AUGUST AUNT AUTHOR AUTO AUTUMN AVERAGE AVOID AWAKE AWARE AWAY AWESOME AWFUL AWKWARD AXIS
BABY BACHELOR BACK BACON BADGE BAG BALANCE BALCONY BALL BAMBOO BANANA BANNER BAR BARE BARELY BARGAIN
BARREL BASE BASIC BASKET BATTLE BEACH BEAN BEAR BEAUTY BECAUSE BECOME BEEF BEFORE BEGIN BEHAVE BEHIND
BELIEVE BELL BELOW BELT BENCH BENEFIT BEST BETTER BETWEEN BEYOND BICYCLE BIG BIKE BILL BIND BIOLOGY
BIRD BIRTH BITTER BLACK BLADE BLAME BLANKET BLAST BLEAK BLESS BLIND BLOOD BLOSSOM BLUE BLUR BLUSH
BOARD BOAT BODY BOIL BOMB BONE BONUS BOOK BOOST BORDER BORING BORROW BOSS BOTH BOTTLE BOTTOM BOUNCE
BOX BOY BRACKET BRAIN BRAND BRAVE BREAD BREAK BREEZE BRICK BRIDGE BRIEF BRIGHT BRING BRISK BROTHER
BROWN BRUSH BUBBLE BUDDY BUDGET BUILD BULK BULLET BUNDLE BUNKER BURDEN BURGER BURN BURST BUSINESS BUSY
BUTTER BUYER BUZZ
CABIN CABLE CACTUS CAGE CAKE CALL CALM CAMEL CAMERA CAMP CAN CANAL CANCEL CANDLE CANDY CANNON CANOE
CANVAS CANYON CAPABLE CAPITAL CAPTAIN CAR CARBON CARD CARE CARGO CARPET CARRY CART CASE CASH CASINO
CASTLE CASUAL CAT CATALOG CATCH CATEGORY CATTLE CAUGHT CAUSE CAUTION CAVE CEILING CELERY CEMENT CENSUS
CENTER CENTURY CEREAL CERTAIN CHAIR CHALK CHAMPION CHANGE CHAOS CHAPTER CHARGE CHASE CHAT CHEAP CHECK
CHEESE CHEF CHERRY CHEST CHICKEN CHIEF CHILD CHIMNEY CHOICE CHOOSE CHRONIC CHUCKLE CHUNK CHURCH CHURN
CIGAR CIRCLE CITIZEN CITY CIVIL CLAIM CLAP CLARIFY CLASS CLASSIC CLEAN CLEAR CLERK CLEVER CLICK CLIENT
CLIFF CLIMB CLINIC CLIP CLOCK CLOSE CLOTH CLOUD CLOWN CLUB CLUMP CLUSTER CLUTCH COACH COAST COCONUT
CODE COFFEE COIL COIN COLD COLLECT COLLEGE COLOR COLUMN COMBINE COME COMFORT COMIC COMMON COMPANY
COMPARE COMPETE COMPLEX COMPUTER CONCERT CONDUCT CONFIRM CONGRESS CONNECT CONSIDER CONTROL CONVINCE
COOK COOL COPPER COPY CORAL CORE CORN CORRECT COST COTTON COUCH COULD COUNT COUNTRY COUPLE COURSE
COURT COUSIN COVER COYOTE CRACK CRADLE CRAFT CRAM CRANE CRASH CRATER CRAWL CRAZY CREAM CREDIT CREEK
CREW CRICKET CRIME CRISP CRITIC CROP CROSS CROUCH CROWD CRUCIAL CRUEL CRUISE CRUMBLE CRUNCH CRUSH CRY
CRYSTAL CUBE CULTURE CUP CUPBOARD CURIOUS CURRENT CURTAIN CURVE CUSHION CUSTOM CUTE CYCLE
DAILY DAMAGE DAMP DANCE DANGER DARING DARK DASH DATA DATE DAUGHTER DAWN DAY DEAL DEBATE DEBRIS DECADE
DECEMBER DECIDE DECLINE DECORATE DECREASE DEER DEFENSE DEFINE DEFY DEGREE DELAY DELIVER DEMAND DEMISE
DENIAL DENTIST DENY DEPART DEPEND DEPOSIT DEPTH DEPUTY DERIVE DESCRIBE DESERT DESIGN DESK DESPAIR
DESTROY DETAIL DETECT DEVELOP DEVICE DEVOTE DIAGRAM DIAL DIAMOND DIARY DICE DIESEL DIET DIFFER DIGITAL
DIGNITY DILEMMA DINNER DINOSAUR DIRECT DIRT DISAGREE DISCOVER DISEASE DISH DISMISS DISPLAY DISTANCE
DISTRICT DISTURB DIVIDE DIZZY DOCTOR DOCUMENT DOG DOLL DOLPHIN DOMAIN DONATE DONKEY DONOR DOOR DOSE
DOUBLE DOVE DOWN DOZEN DRAFT DRAGON DRAMA DRASTIC DRAW DREAM DRESS DRIFT DRILL DRINK DRIP DRIVE DROP
DRUM DRY DUCK DUMB DUNE DURING DUST DUTCH DUTY DWARF DYNAMIC
EACH EAGER EAGLE EARLY EARN EARTH EASILY EAST EASY ECHO ECOLOGY ECONOMY EDGE EDIT EDUCATE EFFORT EGG
EIGHT EITHER ELBOW ELDER ELECTRIC ELEGANT ELEMENT ELEPHANT ELEVATOR ELITE ELSE EMBARK EMBODY EMBRACE
EMERGE EMOTION EMPLOY EMPTY ENABLE ENACT ENDLESS ENDORSE ENEMY ENERGY ENFORCE ENGAGE ENGINE ENHANCE
ENJOY ENLIST ENOUGH ENRICH ENROLL ENSURE ENTER ENTIRE ENTRY ENVELOPE EPISODE EQUAL EQUIP ERA ERASE
ERODE ERROR ERUPT ESCAPE ESSAY ESSENCE ESTATE ETERNAL ETHICS EVOKE EVOLVE EXACT EXAM EXAMPLE EXCHANGE
EXCITE EXCLUDE EXCUSE EXECUTE EXERCISE EXHAUST EXHIBIT EXILE EXIST EXIT EXOTIC EXPAND EXPECT EXPIRE
EXPLAIN EXPOSE EXPRESS EXTEND EXTRA EYE
FABRIC FACE FACT FACULTY FADE FAIL FAINT FAITH FALL FALSE FAME FAMILY FAMOUS FAN FANCY FANTASY FAR
FARM FASHION FAST FAT FATAL FATHER FATIGUE FAULT FAVOR FEATURE FEBRUARY FEDERAL FEE FEED FEEL FEMALE
FENCE FESTIVAL FETCH FEVER FEW FIBER FICTION FIELD FIERCE FIFTEEN FIFTY FIGHT FIGURE FILE FILM FILTER
FINAL FIND FINE FINGER FINISH FIRE FIRM FIRST FISCAL FISH FIT FITNESS FIX FLAG FLAME FLASH FLAT FLAVOR
FLEE FLIGHT FLIP FLOAT FLOCK FLOOR FLOWER FLUID FLUSH FLY FOAM FOCUS FOG FOIL FOLD FOLLOW FOOD FOOT
FORCE FOREST FORGET FORK FORM FORTUNE FORUM FORWARD FOSSIL FOSTER FOUND FOUR FOX FRAGILE FRAME FREQUENT
FRESH FRIEND FRINGE FROG FROM FRONT FROST FROZEN FRUIT FUEL FUN FUNNY FURNACE FURY FUTURE
GADGET GAIN GALAXY GALLERY GAME GAP GARAGE GARBAGE GARDEN GARLIC GARMENT GAS GATE GATHER GAUGE GAZE
GENERAL GENIUS GENRE GENTLE GENUINE GESTURE GHOST GIANT GIFT GIGGLE GINGER GIRAFFE GIRL GIVE GLAD
GLANCE GLARE GLASS GLIDE GLIMPSE GLOBE GLOOM GLORY GLOVE GLOW GLUE GOAT GODDESS GOLD GOOD GOOSE
GORILLA GOSPEL GOSSIP GOVERN GOWN GRAB GRACE GRAIN GRANT GRAPE GRASS GRAVITY GREAT GREEN GRID GRIEF
GRIT GROCERY GROOM GROSS GROUP GROW GRUNT GUARD GUESS GUIDE GUILT GUITAR GUN GYM
HABIT HAIR HALF HALL HAMMER HAND HANDLE HANG HAPPY HARBOR HARD HARSH HARVEST HAT HAVE HAWK HAY HEAD
HEALTH HEART HEAVY HEDGEHOG HEIGHT HELLO HELMET HELP HEN HERO HIDDEN HIGH HILL HINT HIP HIRE HISTORY
HIT HOBBY HOCKEY HOLD HOLE HOLIDAY HOLLOW HOME HONEY HOOD HOPE HORN HORROR HORSE HOSPITAL HOST HOT
HOTEL HOUR HOVER HOW HUB HUGE HUMAN HUMBLE HUMOR HUNDRED HUNGRY HUNT HURDLE HURRY HURT HUSBAND HYBRID
ICE ICON IDEA IDENTIFY IDLE IGNORE ILL ILLEGAL IMAGE IMITATE IMMENSE IMMUNE IMPACT IMPOSE IMPROVE
IMPULSE INCH INCLUDE INCOME INCREASE INDEX INDICATE INDOOR INDUSTRY INFANT INFLICT INFORM INHALE INHERIT
INITIAL INJECT INJURY INMATE INNER INNOCENT INPUT INQUIRY INSANE INSECT INSIDE INSPIRE INSTALL INTACT
INTEREST INTO INVEST INVITE INVOLVE IRON ISLAND ISOLATE ISSUE ITEM IVORY
JACKET JAGUAR JAIL JAM JANUARY JAR JAZZ JEALOUS JEANS JELLY JEWEL JOB JOIN JOKE JOURNEY JOY JUDGE
JUICE JULY JUMP JUNE JUNGLE JUNIOR JUNK JUST
KANGAROO KEEN KEEP KETCHUP KEY KICK KID KIDNEY KIND KINGDOM KISS KIT KITCHEN KITE KITTEN KIWI KNEE
KNIFE KNOCK KNOW
LABEL LABOR LADDER LADY LAKE LAMP LAND LANGUAGE LAPTOP LARGE LAST LATE LATER LATIN LAUGH LAUNDRY LAVA
LAW LAWN LAWSUIT LAYER LAZY LEADER LEAF LEAGUE LEAN LEARN LEASE LEATHER LEAVE LECTURE LEFT LEG LEGAL
LEGEND LEISURE LEMON LEND LENGTH LENS LEOPARD LESSON LETTER LEVEL LIAR LIBERTY LIBRARY LICENSE LICK
LID LIFE LIFT LIGHT LIKE LIMB LIMIT LINE LINK LION LIQUID LIST LISTEN LITTLE LIVE LIZARD LOAD LOAN
LOBSTER LOCAL LOCK LOGIC LONELY LONG LOOP LOOSE LORD LOSE LOUD LOUNGE LOVE LOWER LOYAL LUCKY LUGGAGE
LUMBER LUNCH LUXURY LYRICS
MACHINE MAD MAGIC MAGNET MAID MAIL MAIN MAJOR MAKE MALE MALL MAMMAL MAN MANAGE MANDATE MANGO MANSION
MANUAL MAPLE MARBLE MARCH MARGIN MARINE MARKET MARRIAGE MASK MASS MASTER MATCH MATERIAL MATH MATRIX
MATTER MAXIMUM MAY MAZE MEADOW MEAN MEASURE MEAT MECHANIC MEDAL MEDIA MELODY MELT MEMBER MEMORY MENTION
MENU MERCY MERGE MERIT MERRY MESH MESSAGE METAL METHOD METRIC MIDDLE MIDNIGHT MIGHT MIGRATE MILD MILK
MIND MINIMUM MINOR MINUTE MIRACLE MIRROR MISERY MISS MISTAKE MIX MIXED MIXTURE MOBILE MODEL MODIFY MOM
MOMENT MONDAY MONEY MONITOR MONKEY MONSTER MONTH MOON MORAL MORE MORNING MOSQUITO MOTHER MOTOR MOUNTAIN
MOUSE MOUTH MOVE MOVIE MUCH MUD MUFFIN MULTIPLY MUSCLE MUSEUM MUSHROOM MUSIC MUST MUTUAL MYSELF MYSTERY
MYTH
NAME NAPKIN NARROW NASTY NATION NATURE NEAR NECK NEED NEGATIVE NEGLECT NEITHER NEPHEW NERVE NEST NET
NETWORK NEUTRAL NEVER NEW NEWS NEXT NICE NIGHT NINE NOBLE NOISE NOMINEE NOODLE NORMAL NORTH NOSE NOT
NOTE NOTHING NOTICE NOVEL NOW NUCLEAR NUMBER NURSE NUT
OAK OBEY OBJECT OBLIGE OBSCURE OBSERVE OBTAIN OBVIOUS OCCUR OCEAN OCTOBER ODD ODOR OFF OFFER OFFICE
OFTEN OIL OKAY OLD OLIVE OLYMPIC OMIT ONCE ONE ONION ONLINE ONLY OPEN OPERA OPINION OPPOSE OPTION
ORANGE ORBIT ORCHARD ORDER ORDINARY ORGAN ORIENT ORIGINAL ORPHAN OTHER OUTDOOR OUTER OUTFIT OUTSIDE
OVAL OVEN OVER OWN OWNER OXYGEN OYSTER
PACT PADDLE PAGE PAINT PAIR PALACE PALM PAN PANDA PANEL PANIC PANTHER PAPER PARADE PARENT PARK PARROT
PARTY PASS PATCH PATH PATIENT PATROL PATTERN PAUSE PAVE PAYMENT PEACE PEANUT PEAR PEASANT PELICAN PEN
PENALTY PENCIL PEOPLE PEPPER PERFECT PERMIT PERSON PET PHONE PHOTO PHRASE PHYSICAL PIANO PICK PICTURE
PIECE PIG PIGEON PILL PILOT PINK PIONEER PIPE PISTOL PITCH PIZZA PLACE PLANET PLASTIC PLATE PLAY PLEASE
PLEDGE PLUCK PLUG PLUNGE POEM POET POINT POLAR POLE POLICE POND PONY POOL POPULAR PORTION POSITION
POSSIBLE POST POTATO POTTERY POVERTY POWDER POWER PRACTICE PRAISE PREDICT PREFER PREPARE PRESENT PRETTY
PREVENT PRICE PRIDE PRIMARY PRINT PRIORITY PRISON PRIVATE PRIZE PROBLEM PROCESS PRODUCE PROFIT PROGRAM
PROJECT PROMOTE PROOF PROPERTY PROSPER PROTECT PROUD PROVIDE PUBLIC PUDDING PULL PULSE PUMPKIN PUNCH
PUPIL PUPPY PURCHASE PURE PURPLE PURPOSE PURSE PUSH PUT PUZZLE PYRAMID
QUALITY QUANTUM QUARTER QUEEN QUESTION QUICK QUIT QUIZ QUOTE
RABBIT RACCOON RACE RACK RADAR RADIO RAFT RAGE RAID RAIL RAIN RAISE RALLY RAMP RANCH RANDOM RANGE
RANK RAPID RARE RATE RATHER RAVEN RAW RAZOR REACH REACT READ READY REAL REASON REBEL REBUILD RECALL
RECEIVE RECIPE RECORD RECYCLE RED REDUCE REFLECT REFORM REFUSE REGION REGRET REGULAR REJECT RELAX
RELEASE RELIEF RELY REMAIN REMEMBER REMIND REMOVE RENDER RENEW RENT REOPEN REPAIR REPEAT REPLACE REPORT
REQUIRE RESCUE RESEMBLE RESIST RESOURCE RESPONSE RESULT RETIRE RETREAT RETURN REUNION REVEAL REVIEW
REWARD RHYTHM RIBBON RICE RICH RIDE RIDGE RIFLE RIGHT RIGID RING RIOT RIPPLE RISE RISK RITUAL RIVAL
RIVER ROAD ROAST ROBOT ROBUST ROCKET ROMANCE ROOF ROOKIE ROOM ROOT ROPE ROSE ROTATE ROUGH ROUND ROUTE
ROUTINE ROW ROYAL RUBBER RUDE RUG RULE RUN RUNWAY RURAL RUSH
SACK SACRED SAD SADDLE SADNESS SAFE SAIL SALAD SALMON SALON SALT SALUTE SAME SAMPLE SAND SATISFY
SATURDAY SAUCE SAUSAGE SAVE SAY SCALE SCAN SCARE SCATTER SCENE SCHEME SCHOOL SCIENCE SCISSORS SCOOP
SCORE SCOUT SCRAP SCREEN SCRIPT SCRUB SEA SEARCH SEASON SEAT SECOND SECRET SECTION SECURITY SEED SEEK
SEGMENT SELECT SELL SEMINAR SEND SENIOR SENSE SENTENCE SERIES SERIOUS SERVE SERVICE SESSION SETTLE
SETUP SEVEN SEVER SHADOW SHAFT SHALLOW SHARE SHARK SHARP SHAVE SHE SHED SHEEP SHEET SHELF SHELL SHELTER
SHIFT SHINE SHIP SHIRT SHOCK SHOE SHOOT SHOP SHORT SHOULDER SHOVE SHOW SHRIMP SHRUG SHUFFLE SHUT SHY
SIBLING SICK SIDE SIEGE SIGHT SIGN SILENT SILK SILLY SILVER SIMILAR SIMPLE SINCE SING SINGLE SINK SIR
SISTER SIT SITUATE SIX SIZE SKATE SKETCH SKI SKILL SKIN SKIP SKIRT SKULL SKY SLAP SLAVE SLEEP SLENDER
SLICE SLIDE SLIGHT SLIM SLOGAN SLOT SLOW SLUG SLUSH SMALL SMART SMILE SMOKE SMOOTH SNACK SNAKE SNAP
SNIFF SNOW SOAP SOCCER SOCIAL SOCK SODA SOFT SOLAR SOLDIER SOLID SOLUTION SOLVE SOMEONE SON SONG SOON
SOUL SOUND SOUP SOURCE SOUTH SPACE SPARE SPATIAL SPAWN SPEAK SPECIAL SPEED SPELL SPEND SPHERE SPICE
SPIDER SPIKE SPIN SPIRIT SPLIT SPOIL SPONSOR SPOON SPORT SPOT SPRAY SPREAD SPRING SPY SQUARE SQUEEZE
SQUIRREL STABLE STADIUM STAFF STAGE STAIRS STAMP STAND STAR START STATE STATION STATUE STAY STEAK
STEEL STEM STEP STEREO STICK STILL STING STOCK STOMACH STONE STOOL STOP STORE STORM STORY STOVE STRATEGY
STREET STRIKE STRING STRONG STRUGGLE STUDENT STUDIO STUDY STUFF STUMBLE STYLE SUBJECT SUBMIT SUBWAY
SUCCESS SUCH SUDDEN SUFFER SUGAR SUGGEST SUIT SUMMER SUN SUNNY SUNSET SUPER SUPPLY SUPREME SURE SURFACE
SURGE SURPRISE SURROUND SURVEY SURVIVE SUSPECT SUSTAIN SWALLOW SWAMP SWAP SWARM SWEAR SWEET SWIFT SWIM
SWING SWITCH SWORD SYMBOL SYMPTOM SYRUP SYSTEM
TABLE TACKLE TAIL TAKE TALENT TALK TANK TAPE TARGET TASK TASTE TATTOO TAXI TEACH TEAM TEAR TELL TEMPLE
TEN TENANT TENNIS TENT TERM TERRIBLE TEST TEXT THAN THANK THAT THEME THEN THEORY THERE THESE THEY THICK
THING THINK THIRD THIS THOUGHT THOUSAND THREAT THREE THRIVE THROW THUMB THUNDER THURSDAY TICKET TIDE
TIDY TIGER TIGHT TILE TILT TIME TINY TIP TIRED TISSUE TITLE TOAST TOBACCO TODAY TODDLER TOE TOGETHER
TOILET TOKEN TOMATO TOMORROW TONE TONGUE TONIGHT TOOL TOOTH TOP TOPIC TOPPLE TORCH TORNADO TORTOISE
TOSS TOTAL TOURIST TOWARD TOWER TOWN TOY TRACK TRADE TRAFFIC TRAGIC TRAIL TRAIN TRANSFER TRANSFORM
TRAP TRASH TRAVEL TRAY TREAT TREE TREND TRIAL TRIBE TRICK TRIGGER TRIM TRIP TROPHY TROUBLE TRUCK TRUE
TRULY TRUMPET TRUST TRUTH TRY TUBE TUITION TUMBLE TUNA TUNNEL TURKEY TURN TURTLE TWELVE TWENTY TWICE
TWIN TWIST TWO TYPE TYPICAL
UGLY UMBRELLA UNABLE UNAWARE UNCLE UNCOVER UNDER UNDO UNFAIR UNFOLD UNHAPPY UNIFORM UNIQUE UNIT UNIVERSE
UNKNOWN UNLOCK UNTIL UNUSUAL UNVEIL UPDATE UPGRADE UPHOLD UPON UPPER UPSET URBAN URGE USAGE USE USED
USEFUL USELESS USUAL UTILITY
VACANT VACUUM VAGUE VALID VALLEY VALVE VAN VANISH VAPOR VARIOUS VAST VAULT VEHICLE VELVET VENDOR VENTURE
VENUE VERB VERIFY VERSION VERY VESSEL VETERAN VIABLE VIBRANT VICIOUS VICTIM VICTORY VIDEO VIEW VILLAGE
VINTAGE VIOLIN VIRTUAL VIRUS VISA VISIT VISUAL VITAL VIVID VOCAL VOICE VOID VOLCANO VOLUME VOTE VOYAGE
WAGE WAGON WAIT WALK WALL WALNUT WANT WAR WARM WARN WARRIOR WASH WASP WASTE WATCH WATER WAVE WAY WEALTH
WEAPON WEAR WEASEL WEATHER WEB WEDDING WEDNESDAY WEEK WEEKEND WEIRD WELCOME WELL WEST WET WHALE WHAT
WHEAT WHEEL WHEN WHERE WHETHER WHICH WHILE WHIP WHISPER WHITE WHO WHOLE WIDE WIDOW WIDTH WIFE WILD WILL
WIN WIND WINDOW WINE WING WINNER WINTER WIRE WISDOM WISE WISH WITH WITNESS WOLF WOMAN WONDER WOOD WOOL
WORD WORK WORLD WORRY WORTH WRAP WRECK WRESTLE WRIST WRITE WRONG
YARD YEAR YELLOW YES YESTERDAY YET YIELD YOUNG YOUTH
ZEBRA ZERO ZONE ZOOM
`.trim().split(/\s+/);

export class DictionaryLoader {
  private static instance: DictionaryLoader;
  private trie: Trie | null = null;
  private loadingPromise: Promise<Trie> | null = null;

  private constructor() {}

  static getInstance(): DictionaryLoader {
    if (!DictionaryLoader.instance) {
      DictionaryLoader.instance = new DictionaryLoader();
    }
    return DictionaryLoader.instance;
  }

  async loadDictionary(): Promise<Trie> {
    // Return cached trie if already loaded
    if (this.trie) {
      return this.trie;
    }

    // Return existing loading promise if already loading
    if (this.loadingPromise) {
      return this.loadingPromise;
    }

    // Start loading
    this.loadingPromise = this.loadFromCache().catch(() => this.loadFromSource());
    
    try {
      this.trie = await this.loadingPromise;
      return this.trie;
    } finally {
      this.loadingPromise = null;
    }
  }

  private async loadFromCache(): Promise<Trie> {
    if (typeof window === 'undefined') {
      throw new Error('Cache not available in server environment');
    }

    try {
      const cache = getIndexedDBCache();
      const cached = await cache.get('dictionary_trie');
      
      if (!cached) {
        throw new Error('No cached dictionary found');
      }

      const trie = Trie.deserialize(cached);
      console.log('Dictionary loaded from IndexedDB cache');
      return trie;
    } catch (error) {
      console.error('Failed to load from IndexedDB cache:', error);
      // Try to clear corrupted cache
      try {
        const cache = getIndexedDBCache();
        await cache.remove('dictionary_trie');
      } catch (clearError) {
        console.error('Failed to clear cache:', clearError);
      }
      throw error;
    }
  }

  private async loadFromSource(): Promise<Trie> {
    console.log('Loading dictionary from source...');
    
    // In production, this would fetch the full ENABLE dictionary
    // For now, use our sample dictionary
    const words = await this.fetchDictionary();
    
    const trie = Trie.fromWordList(words);
    
    // Cache the trie in IndexedDB
    if (typeof window !== 'undefined') {
      try {
        const cache = getIndexedDBCache();
        const serialized = trie.serialize();
        await cache.set('dictionary_trie', serialized);
        console.log(`Dictionary cached in IndexedDB (${words.length} words)`);
      } catch (error) {
        console.error('Failed to cache dictionary in IndexedDB:', error);
        // IndexedDB failure is not critical, dictionary will load from source next time
      }
    }
    
    return trie;
  }

  private async fetchDictionary(): Promise<string[]> {
    try {
      // Use the full ENABLE dictionary
      const response = await fetch('/enable1.txt');
      if (!response.ok) {
        throw new Error(`Failed to fetch dictionary: ${response.status}`);
      }
      const text = await response.text();
      const words = text.split('\n')
        .map(word => word.trim().toUpperCase())
        .filter(word => word.length >= 4); // Squaredle uses 4+ letter words
      
      console.log(`Loaded ${words.length} words from ENABLE dictionary`);
      return words;
    } catch (error) {
      console.warn('Failed to load ENABLE dictionary, falling back to sample:', error);
      // Fallback to sample dictionary if ENABLE fails to load
      return SAMPLE_DICTIONARY.filter(word => word.length >= 4);
    }
  }

  getTrie(): Trie | null {
    return this.trie;
  }

  isLoaded(): boolean {
    return this.trie !== null;
  }
}